name: Build ruleset and geodata
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"
      - "**/*.ini"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Set variables
        run: |
          set -e
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          echo "update_time=$(date -d '+8 hours' +'%Y-%m-%d %H:%M:%S')" >> ${GITHUB_ENV}
          echo "domains_download_url=https://raw.githubusercontent.com/Yat-Muk/domain-list-custom/domains" >> ${GITHUB_ENV}
          echo "ips_download_url=https://raw.githubusercontent.com/Yat-Muk/geoip/ips" >> ${GITHUB_ENV}

          # =======================================================
          # AdGuard DNS Filter 源管理 (Sing-box >= 1.10.0)
          # =======================================================
          {
            echo "ADGUARD_SOURCES_CONFIG<<EOF"
            echo "adguard-dns|https://filters.adtidy.org/android/filters/15_optimized.txt"
            echo "adguard-mobile|https://filters.adtidy.org/android/filters/11_optimized.txt"
            echo "adguard-cn|https://filters.adtidy.org/android/filters/224_optimized.txt"
            echo "EOF"
          } >> "$GITHUB_ENV"
          # =======================================================

          curl -sSL https://raw.githubusercontent.com/SagerNet/sing-box/docs/configuration/rule-set/source-format/index.html > sb_doc.html
          
          # 嘗試獲取最新版本，如果因限流失敗，則使用預設版本
          echo "Fetching latest sing-box version..."
          TAG_NAME=$(curl -sSL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.tag_name' || echo "")
          
          # 檢查獲取到的 TAG 是否有效 (是否包含 'v')
          if [[ "$TAG_NAME" != v* ]]; then
             echo "WARNING: GitHub API Rate Limit exceeded or API failed. Using Fallback Version."
             # 使用指定的最新版本 v1.12.12 作為備用
             TAG_NAME="v1.12.12" 
          fi
          
          # 設置版本變量
          RELEASE_VERSION=$(echo "$TAG_NAME" | sed -E 's/([0-9]+)$/0/')
          echo "Using sing-box version: $RELEASE_VERSION (Tag: $TAG_NAME)"
          echo "singbox_core_release_version=$RELEASE_VERSION" >> ${GITHUB_ENV}
          
          echo "singbox_core_last1_version=$(awk '/<li>/ {last=$0} END {print last}' sb_doc.html | sed -n 's/.*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')" >> ${GITHUB_ENV}
          echo "singbox_core_last2_version=$(awk '/<li>/{lines[++count]=$0} END{print lines[count-1]}' sb_doc.html | sed -n 's/.*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')" >> ${GITHUB_ENV}
          echo "singbox_core_last3_version=$(awk '/<li>/{lines[++count]=$0} END{print lines[count-2]}' sb_doc.html | sed -n 's/.*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')" >> ${GITHUB_ENV}
          
          echo "singbox_rules_last1_version=$(awk '/<li>/ {last=$0} END {print last}' sb_doc.html | sed -n 's/^<li>\([0-9]\+\).*/\1/p')" >> ${GITHUB_ENV}
          echo "singbox_rules_last2_version=$(awk '/<li>/{lines[++count]=$0} END{print lines[count-1]}' sb_doc.html | sed -n 's/^<li>\([0-9]\+\).*/\1/p')" >> ${GITHUB_ENV}
          echo "singbox_rules_last3_version=$(awk '/<li>/{lines[++count]=$0} END{print lines[count-2]}' sb_doc.html | sed -n 's/^<li>\([0-9]\+\).*/\1/p')" >> ${GITHUB_ENV}
          
          rm -f sb_doc.html
        shell: bash

      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Checkout Yat-Muk/domain-list-custom
        uses: actions/checkout@v4
        with:
          repository: Yat-Muk/domain-list-custom
          path: custom

      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./custom/go.mod
          cache-dependency-path: ./custom/go.sum

      - name: Generate 'mihomo' geodata
        run: |
          set -e
          mkdir -p ./community/mydata/
          archs1=(private ads trackerslist microsoft-cn apple-cn google-cn games-cn media games ai networktest tld-proxy gfw proxy cn)
          archs2=(private ads trackerslist microsoft-cn apple-cn google-cn games-cn ai networktest tld-proxy gfw proxy cn)
          archs3=(private microsoft-cn apple-cn google-cn games-cn tld-proxy gfw cn-lite)

          cd ./community/

          download_and_convert() {
            curl -sSL "${domains_download_url}/${1}.list" | \
            sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' -e 's/DOMAIN-KEYWORD,/keyword:/' -e 's/DOMAIN-REGEX,/regexp:/' | \
            sed '/_vmind\.qqvideo\.tc\.qq\.com/d' > "./mydata/${1}"
          }

          for arch in "${archs1[@]}"; do
            download_and_convert "$arch"
          done
          
          curl -sSL "${domains_download_url}/fakeip-filter.list" > ./temp_fakeip.list
          
          awk '!/^DOMAIN-REGEX,/' ./temp_fakeip.list | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./mydata/fakeip-filter
          cat <<EOF >> ./mydata/fakeip-filter
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' ./temp_fakeip.list | sed 's/DOMAIN-REGEX,/regexp:/' >> ./mydata/fakeip-filter
          
          go run ./ --datapath=./mydata/ --outputname geosite-all.dat

          rm -f ./mydata/ads ./mydata/fakeip-filter
          
          curl -sSL "${domains_download_url}/fakeip-filter-lite.list" > ./temp_fakeip_lite.list
          awk '!/^DOMAIN-REGEX,/' ./temp_fakeip_lite.list | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./mydata/fakeip-filter-lite
          cat <<EOF >> ./mydata/fakeip-filter-lite
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          go run ./ --datapath=./mydata/ --outputname geosite-all-lite.dat

          rm -f ./mydata/*
          for arch in "${archs2[@]}"; do
            download_and_convert "$arch"
          done
          
          awk '!/^DOMAIN-REGEX,/' ./temp_fakeip.list | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./mydata/fakeip-filter
          cat <<EOF >> ./mydata/fakeip-filter
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' ./temp_fakeip.list | sed 's/DOMAIN-REGEX,/regexp:/' >> ./mydata/fakeip-filter
          
          go run ./ --datapath=./mydata/ --outputname geosite.dat

          rm -f ./mydata/ads ./mydata/fakeip-filter
          awk '!/^DOMAIN-REGEX,/' ./temp_fakeip_lite.list | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./mydata/fakeip-filter-lite
          cat <<EOF >> ./mydata/fakeip-filter-lite
          keyword:ntp
          keyword:time
          keyword:stun
          EOF
          go run ./ --datapath=./mydata/ --outputname geosite-lite.dat

          rm -f ./mydata/*
          for arch in "${archs3[@]}"; do
            download_and_convert "$arch"
          done
          mv -f ./mydata/cn-lite ./mydata/cn
          go run ./ --datapath=./mydata/ --outputname geosite-mini.dat

          rm -f ./temp_fakeip.list ./temp_fakeip_lite.list

      - name: Generate 'sing-box' geodata
        run: |
          cd ./community/ || exit 1
          go install -trimpath -ldflags="-s -w -buildid=" github.com/metacubex/geo/cmd/geo@master
          for file in $(ls *.dat | sed 's/\.dat$//'); do
            geo convert site -i v2ray -o sing -f "./${file}.db" "./${file}.dat"
          done

      - name: Get geoip relative files
        run: |
          mkdir -p ./mihomo-geodata/ ./sing-box-geodata/
          
          # 嘗試獲取 Release
          echo "Fetching GeoIP releases..."
          curl -sSL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/Yat-Muk/geoip/releases > geoip_releases.json || echo "{}" > geoip_releases.json
          
          grep '"browser_download_url"' geoip_releases.json | grep '.mmdb' | awk -F '"' '{print $4}' | while read url; do
            wget -q -P ./mihomo-geodata/ "$url" &
          done

          grep '"browser_download_url"' geoip_releases.json | grep '/mihomo-geodata/' | grep -v '.mmdb' | awk -F '"' '{print $4}' | while read url; do
             wget -q -P ./community/ "$url" &
          done

          grep '"browser_download_url"' geoip_releases.json | grep '/sing-box-geodata/' | awk -F '"' '{print $4}' | while read url; do
             wget -q -P ./community/ "$url" &
          done
          
          wait
          rm -f geoip_releases.json

      - name: Move 'mihomo' and 'sing-box' geodata files
        run: |
          cd ./community/ || exit 1
          for file in $(ls *.dat *.metadb); do
            install -Dp "./${file}" ../mihomo-geodata/
          done
          for file in $(ls *.db); do
            install -Dp "./${file}" ../sing-box-geodata/
          done
          rm -rf ../custom* ../community*

      - name: Download 'mihomo' rule-set files
        run: |
          set -e
          mkdir -p ./mihomo-ruleset/
          domains=(ads private trackerslist microsoft-cn apple-cn google-cn games-cn netflix disney max primevideo appletv applenews applemusic apple_classical google youtube tiktok bilibili spotify media games ai networktest tld-proxy gfw proxy cn cn-lite adobe hulu telegram youtubemusic twitter truthSocial github gitlab cloudflare douyin duolingo facebook instagram shopee wechat binance)
          ips=(netflixip mediaip gamesip privateip cnip telegramip adsip)

          process_domain() {
             local dom=$1
             local dir="./tools/domains/${dom}"
             mkdir -p "$dir"
             curl -sSL "${domains_download_url}/${dom}.list" | \
              grep -E '^(DOMAIN,|DOMAIN-SUFFIX,)' | \
              sed -e 's/^DOMAIN,//' -e 's/^DOMAIN-SUFFIX,/\+\./' \
              > "${dir}/${dom}.list"
             
             if [ ! -s "${dir}/${dom}.list" ]; then
               rm -f "${dir}/${dom}.list"
               rmdir --ignore-fail-on-non-empty "$dir"
             fi
          }

          for domain in "${domains[@]}"; do
            process_domain "$domain"
          done

          for type in fakeip-filter fakeip-filter-lite; do
             mkdir -p "./tools/domains/${type}/"
             curl -sSL "${domains_download_url}/${type}.list" | \
               grep -E '^(DOMAIN,|DOMAIN-SUFFIX,)' | \
               sed -e 's/^DOMAIN,//' -e 's/^DOMAIN-SUFFIX,/\+\./' \
               > "./tools/domains/${type}/${type}.list"
             if [ ! -s "./tools/domains/${type}/${type}.list" ]; then
               rm -f "./tools/domains/${type}/${type}.list"
               rmdir --ignore-fail-on-non-empty "./tools/domains/${type}/"
             fi
          done

          process_domain "private"

          curl -sSL "${domains_download_url}/applications.list" > ./mihomo-ruleset/applications.list

          for ip in "${ips[@]}"; do
            mkdir -p "./tools/ips/${ip}/"
            dl_url=""
            if [[ "$ip" == "adsip" ]]; then
              dl_url="${domains_download_url}/${ip}.list"
            else
              dl_url="${ips_download_url}/${ip}.list"
            fi

            curl -sSL "${dl_url}" | \
              grep -E '^(IP-CIDR,|IP-CIDR6,)' | \
              sed 's/^IP-CIDR,\|^IP-CIDR6,//' \
              > "./tools/ips/${ip}/${ip}.list"
            
             if [ ! -s "./tools/ips/${ip}/${ip}.list" ]; then
                rm -f "./tools/ips/${ip}/${ip}.list"
                rmdir --ignore-fail-on-non-empty "./tools/ips/${ip}/"
             fi
          done
          rm -rf ./tmp/

      - name: Download 'sing-box' rule_set files
        run: |
          mkdir -p ./tmp/
          domains=(ads private trackerslist microsoft-cn apple-cn google-cn games-cn netflix disney max primevideo appletv applenews applemusic apple_classical google youtube tiktok bilibili spotify media games ai networktest tld-proxy gfw proxy cn cn-lite adobe hulu telegram youtubemusic twitter truthSocial github gitlab cloudflare douyin duolingo facebook instagram shopee wechat binance)
          ips=(netflixip mediaip gamesip privateip cnip telegramip adsip)

          for domain in "${domains[@]}"; do
            mkdir -p "./tools/rules/${domain}/"
            curl -sSL "${domains_download_url}/${domain}.list" > "./tools/rules/${domain}/${domain}.list"
          done

          mkdir -p ./tools/rules/fakeip-filter/
          curl -sSL "${domains_download_url}/fakeip-filter.list" > ./tmp/temp-fakeip.txt
          {
             awk '!/^DOMAIN-REGEX,/' ./tmp/temp-fakeip.txt
             echo "DOMAIN-KEYWORD,ntp"
             echo "DOMAIN-KEYWORD,stun"
             echo "DOMAIN-KEYWORD,time"
             awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' ./tmp/temp-fakeip.txt
          } | sort --ignore-case > ./tools/rules/fakeip-filter/fakeip-filter.list

          mkdir -p ./tools/rules/fakeip-filter-lite/
          curl -sSL "${domains_download_url}/fakeip-filter-lite.list" > ./tmp/temp-fakeip-lite.txt
          {
             awk '!/^DOMAIN-REGEX,/' ./tmp/temp-fakeip-lite.txt
             echo "DOMAIN-KEYWORD,ntp"
             echo "DOMAIN-KEYWORD,stun"
             echo "DOMAIN-KEYWORD,time"
          } | sort --ignore-case > ./tools/rules/fakeip-filter-lite/fakeip-filter-lite.list

          mkdir -p ./tools/rules/applications/
          curl -sSL "${domains_download_url}/applications.list" > "./tools/rules/applications/applications.list"

          for ip in "${ips[@]}"; do
            mkdir -p "./tools/rules/${ip}/"
            dl_url=""
            if [[ "$ip" == "adsip" ]]; then
              dl_url="${domains_download_url}/${ip}.list"
            else
              dl_url="${ips_download_url}/${ip}.list"
            fi
            curl -sSL "${dl_url}" > "./tools/rules/${ip}/${ip}.list"
          done
          rm -rf ./tmp*

      - name: Generate 'mihomo' rule-set (yaml)
        run: |
          set -eo pipefail
          domains=(trackerslist microsoft-cn apple-cn google-cn games-cn netflix disney max primevideo appletv applenews applemusic apple_classical google youtube tiktok bilibili spotify media games ai networktest tld-proxy gfw proxy cn cn-lite adobe hulu telegram youtubemusic twitter truthSocial github gitlab cloudflare binance douyin duolingo facebook instagram shopee wechat binance)
          ips=(netflixip mediaip gamesip privateip cnip telegramip)

          generate_yaml_ruleset() {
            local item_name=$1
            local download_url=$2
            local output_file="./mihomo-ruleset/${item_name}.yaml"
            echo "Generating YAML ruleset for: ${item_name}"
            
            local content
            content=$(curl -sSL "${download_url}" | grep -E '^(DOMAIN|IP-CIDR|PROCESS-NAME|DOMAIN-KEYWORD|DOMAIN-SUFFIX|DOMAIN-REGEX)' || true)
            
            local count_domain=$(grep -c '^DOMAIN,' <<< "$content" || true)
            local count_keyword=$(grep -c '^DOMAIN-KEYWORD,' <<< "$content" || true)
            local count_suffix=$(grep -c '^DOMAIN-SUFFIX,' <<< "$content" || true)
            local count_ipcidr=$(grep -c '^IP-CIDR' <<< "$content" || true)
            local count_process=$(grep -c '^PROCESS-NAME,' <<< "$content" || true)
            local count_regex=$(grep -c '^DOMAIN-REGEX,' <<< "$content" || true)
            local total=$((count_domain + count_keyword + count_suffix + count_ipcidr + count_process + count_regex))
            
            local name=$(echo "${item_name}" | sed -e "s/^\(.\)/\U\1/")
            {
              echo "# NAME: ${name}"
              echo "# AUTHOR: Yat-Muk"
              echo "# REPO: https://github.com/Yat-Muk/ruleset_geodata"
              echo "# UPDATED: ${{ env.update_time }}"
              echo "# DOMAIN: ${count_domain}"
              echo "# DOMAIN-KEYWORD: ${count_keyword}"
              echo "# DOMAIN-SUFFIX: ${count_suffix}"
              echo "# DOMAIN-REGEX: ${count_regex}"
              echo "# IP-CIDR: ${count_ipcidr}"
              echo "# PROCESS-NAME: ${count_process}"
              echo "# TOTAL: ${total}"
              echo "payload:"
            } > "${output_file}"
            
            if [ -n "${content}" ]; then
              echo "${content}" | sort | sed 's/^/  - /' >> "${output_file}"
            fi
          }

          generate_merged_ads_ruleset() {
            echo "Generating MERGED YAML ruleset for: ads"
            local output_file="./mihomo-ruleset/ads.yaml"
            local content_domain=$(curl -sSL "${domains_download_url}/ads.list" | grep -E '^(DOMAIN|IP-CIDR|PROCESS-NAME|DOMAIN-KEYWORD|DOMAIN-SUFFIX|DOMAIN-REGEX)' || true)
            local content_ip=$(curl -sSL "${domains_download_url}/adsip.list" | grep -E '^(IP-CIDR,|IP-CIDR6,)' || true)
            local content
            content=$(echo -e "${content_domain}\n${content_ip}" | grep .)
            
            local count_domain=$(grep -c '^DOMAIN,' <<< "$content" || true)
            local count_keyword=$(grep -c '^DOMAIN-KEYWORD,' <<< "$content" || true)
            local count_suffix=$(grep -c '^DOMAIN-SUFFIX,' <<< "$content" || true)
            local count_ipcidr=$(grep -c -E '^IP-CIDR' <<< "$content" || true)
            local count_process=$(grep -c '^PROCESS-NAME,' <<< "$content" || true)
            local count_regex=$(grep -c '^DOMAIN-REGEX,' <<< "$content" || true)
            local total=$((count_domain + count_keyword + count_suffix + count_ipcidr + count_process + count_regex))
            
            {
              echo "# NAME: Ads"
              echo "# AUTHOR: Yat-Muk"
              echo "# REPO: https://github.com/Yat-Muk/ruleset_geodata"
              echo "# UPDATED: ${{ env.update_time }}"
              echo "# DOMAIN: ${count_domain}"
              echo "# DOMAIN-KEYWORD: ${count_keyword}"
              echo "# DOMAIN-SUFFIX: ${count_suffix}"
              echo "# DOMAIN-REGEX: ${count_regex}"
              echo "# IP-CIDR: ${count_ipcidr}"
              echo "# PROCESS-NAME: ${count_process}"
              echo "# TOTAL: ${total}"
              echo "payload:"
            } > "${output_file}"
            
            if [ -n "${content}" ]; then
              echo "${content}" | sort | sed 's/^/  - /' >> "${output_file}"
            fi
          }

          for item in "${domains[@]}"; do
            generate_yaml_ruleset "${item}" "${domains_download_url}/${item}.list"
          done
          generate_yaml_ruleset "applications" "${domains_download_url}/applications.list"
          generate_yaml_ruleset "fakeip-filter" "${domains_download_url}/fakeip-filter.list"
          generate_yaml_ruleset "fakeip-filter-lite" "${domains_download_url}/fakeip-filter-lite.list"
          for item in "${ips[@]}"; do
              if [[ "$item" != "adsip" ]]; then
                generate_yaml_ruleset "${item}" "${ips_download_url}/${item}.list"
              fi
          done
          generate_merged_ads_ruleset

      - name: Generate 'mihomo' rule-set (mrs) and move .list files
        run: |
          curl -L https://github.com/DustinWin/proxy-tools/releases/download/mihomo/mihomo-meta-linux-amd64v3.tar.gz | tar -zx -C ./tools/
          mv -f ./tools/CrashCore ./tools/mihomo
          cd ./tools/
          chmod +x ./mihomo

          find ./domains/ -maxdepth 2 -name '*.list' -type f | while read file_path; do
              dir_name=$(basename $(dirname "$file_path"))
              if [ -s "$file_path" ]; then
                ./mihomo convert-ruleset domain text "$file_path" "../mihomo-ruleset/${dir_name}.mrs"
              fi
              mv -f "$file_path" ../mihomo-ruleset/
          done

          find ./ips/ -maxdepth 2 -name '*.list' -type f | while read file_path; do
              dir_name=$(basename $(dirname "$file_path"))
              if [ -s "$file_path" ]; then
                ./mihomo convert-ruleset ipcidr text "$file_path" "../mihomo-ruleset/${dir_name}.mrs"
              fi
              mv -f "$file_path" ../mihomo-ruleset/
          done

          rm -rf ./mihomo* ./domains/ ./ips/

      - name: Generate 'sing-box' rule_set (srs) and move .json files
        run: |
          process_singbox() {
             local version=$1
             local rules_version=$2
             local target_dir=$3
             
             # 下載 sing-box
             curl -L "https://github.com/SagerNet/sing-box/releases/download/v${version}/sing-box-${version}-linux-amd64.tar.gz" | tar -zx -C ./tools/
             mv -f "./tools/sing-box-${version}-linux-amd64/sing-box" ./tools/sing-box
             mkdir -p "$target_dir"
             
             cd ./tools/
             chmod +x ./sing-box
             
             # ================= [AdGuard 編譯邏輯 (Convert Mode)] =================
             # 1. 版本檢查
             local ver_major=$(echo "$version" | cut -d. -f1)
             local ver_minor=$(echo "$version" | cut -d. -f2)
             
             if [[ "$ver_major" -gt 1 ]] || [[ "$ver_major" -eq 1 && "$ver_minor" -ge 10 ]]; then
                 echo "Sing-box version ${version} >= 1.10.0. Starting AdGuard conversion..."
                 
                 # 2. 讀取配置
                 readarray -t RAW_SOURCES <<< "$ADGUARD_SOURCES_CONFIG"
                 
                 # 3. 下載並合併文件
                 > all_adguard.txt
                 has_source=false
                 
                 for line in "${RAW_SOURCES[@]}"; do
                    line=$(echo "$line" | sed 's/^[ \t]*//;s/[ \t]*$//')
                    # 過濾空行和註釋
                    if [[ -n "$line" && "$line" != \#* ]]; then
                        url="${line##*|}"
                        tag="${line%%|*}"
                        echo "Downloading AdGuard source: $tag ($url)"
                        curl -sSL "$url" >> all_adguard.txt
                        echo "" >> all_adguard.txt
                        has_source=true
                    fi
                 done
                 
                 if [ "$has_source" = true ]; then
                     # 4. 執行轉換命令
                     echo "Converting merged AdGuard list to SRS..."
                     ./sing-box rule-set convert --type adguard --output adguard.srs all_adguard.txt || echo "AdGuard conversion failed"
                 else
                     echo "No active AdGuard sources found."
                 fi
             else
                 echo "Skipping AdGuard. Version ${version} < 1.10.0."
             fi
             # =================================================================

             if [[ -f "./convert.sh" ]]; then
               sed -i "s/\"version\": [0-9]\+/\"version\": ${rules_version}/" ./convert.sh
               chmod +x ./convert.sh && ./convert.sh
               mv -f ./*.json ./*.srs "../${target_dir}/"
             else
               echo "Error: convert.sh not found"
               exit 1
             fi
             rm -rf ./sing-box*
             cd ..
          }

          if [[ "${{ env.singbox_core_last1_version }}" == "${{ env.singbox_core_release_version }}" ]]; then
            echo "singbox_core_old_version=${{ env.singbox_core_last2_version }}" >> $GITHUB_ENV
            echo "singbox_core_new_version=${{ env.singbox_core_last1_version }}" >> $GITHUB_ENV
            echo "singbox_ruleset_old_version=${{ env.singbox_rules_last2_version }}" >> $GITHUB_ENV
            echo "singbox_ruleset_new_version=${{ env.singbox_rules_last1_version }}" >> $GITHUB_ENV
            echo "singbox_equal=true" >> $GITHUB_ENV

            process_singbox "${{ env.singbox_core_last2_version }}" "${{ env.singbox_rules_last2_version }}" "sing-box-ruleset-compatible"
            process_singbox "${{ env.singbox_core_last1_version }}" "${{ env.singbox_rules_last1_version }}" "sing-box-ruleset"
          else
            echo "singbox_core_old_version=${{ env.singbox_core_last3_version }}" >> $GITHUB_ENV
            echo "singbox_core_new_version=${{ env.singbox_core_last2_version }}" >> $GITHUB_ENV
            echo "singbox_ruleset_old_version=${{ env.singbox_rules_last3_version }}" >> $GITHUB_ENV
            echo "singbox_ruleset_new_version=${{ env.singbox_rules_last2_version }}" >> $GITHUB_ENV
            echo "singbox_equal=false" >> $GITHUB_ENV

            process_singbox "${{ env.singbox_core_last3_version }}" "${{ env.singbox_rules_last3_version }}" "sing-box-ruleset-compatible"
            process_singbox "${{ env.singbox_core_last2_version }}" "${{ env.singbox_rules_last2_version }}" "sing-box-ruleset"
          fi
          
          rm -rf ./tools/rules*

      - name: Release and upload 'mihomo-geodata' assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: mihomo-geodata
          tag: mihomo-geodata
          overwrite: true
          body: |
            [mihomo 内核](https://github.com/MetaCubeX/mihomo) geodata 文件
            geodata 文件更新于 ${{ env.update_version }}
          file_glob: true
          file: ./mihomo-geodata/*

      - name: Commit and push 'mihomo-geodata' branch
        run: |
          cd ./mihomo-geodata/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b mihomo-geodata
          git add . && git commit -m "mihomo 内核 geodata 文件更新于 ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin mihomo-geodata

      - name: Release and upload 'mihomo-ruleset' assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: mihomo-ruleset
          tag: mihomo-ruleset
          overwrite: true
          body: |
            [mihomo 内核](https://github.com/MetaCubeX/mihomo) rule-set 規則集文件
            包含 .mrs, .list, 和 .yaml 格式
            規則集文件更新于 ${{ env.update_version }}
          file_glob: true
          file: ./mihomo-ruleset/*

      - name: Commit and push 'mihomo-ruleset' branch
        run: |
          cd ./mihomo-ruleset/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b mihomo-ruleset
          git add . && git commit -m "mihomo 内核 rule-set 規則集文件更新于 ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin mihomo-ruleset

      - name: Release and upload 'sing-box-geodata' assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: sing-box-geodata
          tag: sing-box-geodata
          overwrite: true
          body: |
            [sing-box 内核](https://github.com/SagerNet/sing-box) geodata 文件
            geodata 文件更新于 ${{ env.update_version }}
          file_glob: true
          file: ./sing-box-geodata/*

      - name: Commit and push 'sing-box-geodata' branch
        run: |
          cd ./sing-box-geodata/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b sing-box-geodata
          git add . && git commit -m "sing-box 内核 geodata 文件更新于 ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin sing-box-geodata

      - name: Release and upload 'sing-box-ruleset-compatible' assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: sing-box-ruleset-compatible
          tag: sing-box-ruleset-compatible
          overwrite: true
          body: |
            [sing-box 内核](https://github.com/SagerNet/sing-box) rule_set 規則集文件
            適用於 v${{ env.singbox_core_old_version }}-v${{ env.singbox_core_new_version }}（不包含）系列版本的 sing-box 内核（`"version": ${{ env.singbox_ruleset_old_version }}`）
            規則集文件更新于 ${{ env.update_version }}
          file_glob: true
          file: ./sing-box-ruleset-compatible/*

      - name: Commit and push 'sing-box-ruleset-compatible' branch
        run: |
          cd ./sing-box-ruleset-compatible/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b sing-box-ruleset-compatible
          git add . && git commit -m "sing-box 内核 rule_set 規則集文件更新于 ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin sing-box-ruleset-compatible

      - name: Release and upload 'sing-box-ruleset' assets
        if: ${{ env.singbox_equal == 'true' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: sing-box-ruleset
          tag: sing-box-ruleset
          overwrite: true
          body: |
            [sing-box 内核](https://github.com/SagerNet/sing-box) rule_set 規則集文件
            適用於 v${{ env.singbox_core_new_version }} 系列版本的 sing-box 内核（`"version": ${{ env.singbox_ruleset_new_version }}`）
            規則集文件更新于 ${{ env.update_version }}
          file_glob: true
          file: ./sing-box-ruleset/*

      - name: Release and upload 'sing-box-ruleset' assets
        if: ${{ env.singbox_equal == 'false' }}
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: sing-box-ruleset
          tag: sing-box-ruleset
          overwrite: true
          body: |
            [sing-box 内核](https://github.com/SagerNet/sing-box) rule_set 規則集文件
            適用於 v${{ env.singbox_core_new_version }}（包含）+ 系列版本的 sing-box 内核（`"version": ${{ env.singbox_ruleset_new_version }}`）
            規則集文件更新于 ${{ env.update_version }}
          file_glob: true
          file: ./sing-box-ruleset/*

      - name: Commit and push 'sing-box-ruleset' branch
        run: |
          cd ./sing-box-ruleset/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b sing-box-ruleset
          git add . && git commit -m "sing-box 内核 rule_set 規則集文件更新于 ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin sing-box-ruleset

      - name: Purge jsDelivr CDN
        run: |
          purge_urls=(
            "mihomo-geodata"
            "sing-box-geodata"
            "mihomo-ruleset"
            "sing-box-ruleset-compatible"
            "sing-box-ruleset"
          )
          
          for repo in "${purge_urls[@]}"; do
             if [ -d "./${repo}/" ]; then
                cd "./${repo}/" || continue
                for file in *; do
                   if [ -f "$file" ]; then
                     curl -i -s "https://purge.jsdelivr.net/gh/${{ github.repository }}@${repo}/${file}" > /dev/null
                   fi
                done
                cd ..
             fi
          done

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 3
          keep_minimum_runs: 1
